#
# Copyright (c) 2019-2023 Ruben Perez Hidalgo (rubenperez038 at gmail dot com)
#
# Distributed under the Boost Software License, Version 1.0. (See accompanying
# file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)
#

import os ;
import path ;
import openssl ;

project /boost/mysql/test ;

# Requirements to use across targets
local requirements = 
        <define>BOOST_ALL_NO_LIB=1
        <define>BOOST_ASIO_NO_DEPRECATED=1
        <define>BOOST_ASIO_DISABLE_BOOST_ARRAY=1
        <define>BOOST_ASIO_DISABLE_BOOST_BIND=1
        <define>BOOST_ASIO_DISABLE_BOOST_DATE_TIME=1
        <define>BOOST_ASIO_DISABLE_BOOST_REGEX=1
        <define>BOOST_ASIO_HAS_DEFAULT_FUNCTION_TEMPLATE_ARGUMENTS=1
        <define>BOOST_ALLOW_DEPRECATED_HEADERS=1
        <toolset>msvc:<cxxflags>"/bigobj"
        <toolset>msvc-14.1:<cxxflags>"/permissive-"
        <toolset>msvc-14.2:<cxxflags>"/permissive-"
        <toolset>msvc:<define>_SCL_SECURE_NO_WARNINGS=1
        <toolset>msvc:<define>_SILENCE_CXX17_ALLOCATOR_VOID_DEPRECATION_WARNING
        <toolset>msvc:<define>_SILENCE_CXX17_ADAPTOR_TYPEDEFS_DEPRECATION_WARNING
        <toolset>msvc:<define>_SILENCE_CXX17_ITERATOR_BASE_CLASS_DEPRECATION_WARNING
        <target-os>linux:<define>_XOPEN_SOURCE=600
        <target-os>linux:<define>_GNU_SOURCE=1
        <target-os>windows:<define>_WIN32_WINNT=0x0601
    ;

# Common settings to be applied to tests and examples
alias common_target_settings
    : requirements $(requirements)
    : usage-requirements $(requirements)
;


# A library with utilities and an asio separate build, to speed up
lib test_common
    :
        common_target_settings
        common/src/asio.cpp
        common/src/tracker_executor.cpp
        common/src/utf_entry_point.cpp
        # Unit test library generates some internal warnings we're not interested in.
        # Dynamic linking against UTF allows us to define our own main, without playing with UTF macros
        /boost/test//boost_unit_test_framework/<warnings-as-errors>off/<link>shared
    :
        <include>common/include
        <define>BOOST_ASIO_SEPARATE_COMPILATION
    :
    :
        <include>common/include
        <define>BOOST_ASIO_SEPARATE_COMPILATION
    ;

build-project unit ;
build-project unit_iface ;
