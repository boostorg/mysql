#
# Copyright (c) 2019-2023 Ruben Perez Hidalgo (rubenperez038 at gmail dot com)
#
# Distributed under the Boost Software License, Version 1.0. (See accompanying
# file LICENSE_1_0.txt or copy at http://www.boost.org/LICENSE_1_0.txt)
#

import os ;

path-constant tsan_suppressions : suppressions.txt ;

# The hostname to use for tests
local hostname = [ os.environ BOOST_MYSQL_SERVER_HOST ] ;
if $(hostname) = ""
{
    hostname = "localhost" ;
}

# TSAN can't be enabled in our ARM CIs, since they fail
# the personality() syscall to disable address space layout randomization
rule tsan_if_not_arm ( properties * )
{
    local result ;
    if ! <architecture>arm in $(properties)
    {
        result += <thread-sanitizer>norecover ;
    }
    return $(result) ;
}

run
        /boost/mysql/test//boost_mysql_compiled
        connection_pool.cpp
    : requirements
        <testing.arg>$(hostname)
        <conditional>@tsan_if_not_arm
        <toolset>clang-darwin:<cxxflags>-fsanitize-blacklist=$(tsan_suppressions)
    : target-name boost_mysql_thread_safety
;
